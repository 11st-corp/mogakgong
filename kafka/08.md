# 8. 카프카 버전 업그레이드와 확장

카프카는 시맨틴 버전을사용 (메이저.마이너.패치)

- 메이저 : 이전과 호환되지 않는 API 변경시 증가
- 마이너 : 이전과 호환되는 새로운 기능 추가시 증가
- 패치 : 이전과 호환되는 버그 수정시 증가
- 메이저 버전 업그레이드시, 마이너 버전으로 먼저 업그레이드 후 진행하는 것을 권장.

# 카프카 버전 업그레이드를 위한 준비

- 사전작업
    - 가장 먼저 자신이 사용하는 카프카 버전 확인
        - 명령어로 확인하는 방법 ([kafka-topics.sh](http://kafka-topics.sh) —version )
        - 카프카 폴더 > libs 하위 디렉토리에서 jar 파일을 이용하는 방법 
        (카프카 설치 경로 : /usr/local/kafka)
        → ls -l /usr/local/kafka/libs/kafka_*
    - 업그레이드하려는 버전을 정하여, 릴리스 노트 확인하기
- 업그레이드 방법
    - 다운타임을 가질 수 있다면? 현재 버전 카프카 모두 종료 후 최신 버전 카프카 실행
    - 다운타임을 가질 수 없다면? **브로커 한 대씩 롤링 업그레이드**
    - 대부분 다운타임을 가지기 어려움

# 주키퍼 의존성이 있는 카프카 롤링 업그레이드

ex. 2.1 버전에서 2.6으로 올리기

- 최신 버전 카프카 다운로드 + 설정
    - 단, 브로커 간 내부통신과 메시지 포맷 설정은 업그레이드 전 버전(2.1)으로 유지할 것
    - 업데이트 된 브로커를 실행했을 때, 아직 업데이트 되지 않은 브로커들과의 통신이 불가하기 때문에.. 브로커들간에 통신을 지원하기 위해 유지
- 브로커 버전 업그레이드
    - 한 대씩 순차적으로 브로커 버전 업그레이드 진행
    - 브로커 서버 한 대 종료
        - 브로커 서버는 종료시 파티션의 리더들이 다른 브로커로 변경되고, 일시적인 타임아웃이나 리더를 찾지 못한다는 에러가 생김
    - 종료 후 kafka 심볼릭 링크를 2.1에서 2.6으로 변경
        - 카프카 버전 2.6으로 업그레이드
        - 이 때 1번의 내용처럼 브로커 프로토컬 버전, 메시지 포맷 버전은 전 버전(2.1)
    - 정리
        - 브로커 서버 접속
        - /usr/local 경로로 이동
        - 브로커 종료
        - kafka 심볼릭 링크 삭제
        - kafka 심볼릭 링크 2.6 버전으로 재생성
        - 설정 파일 복사 및 옵션 설정
        - 브로커 시작
- 브로커 설정 변경
    - 앞선 브로커 버전 업그레이드 및 실행이 끝났을 경우, 브로커 프로토컬 버전, 메시지 포맷 버전 변경 진행
        - 프로토컬 버전, 메시지 포맷 버전 내용을 변경하기 보다는 삭제를 권장
    - 브로커를 한 대씩 재시작하여 브로커 설정 변경 적용
- 업그레이드 작업시 주의 사항
    - 운영환경과 동일한 카프카 버전으로 개발용 카프카 구성해보고 개발용 카프카의 버전 업그레이드 수행
    - 경험이 적다면, 카프카 사용량이 적은 시간대로 업그레이드 자업 실시
    - 프로듀서의 ack=1 옵션을 사용하는 경우 롤링 재시작시 일부 메시지 손실될 수 있음 → 프로듀서 옵션에 대해서 면밀히 검토해볼 것 권장

# 카프카의 확장

- 손쉽게 확장이 가능하다.
- 브로커 고유 id 부여하여 브로커 추가 > 수작업으로 토픽 파티션 분산 (자동 분산X)
- 브로커 부하를 고르게 분산하기
    - [kafka-reassign-parition.sh](http://kafka-reassign-parition.sh) 도구 이용하면 파티션 이동 가능
    - 분산 작업 순서
        - 분산시킬 토픽 정하기
        - 토픽의 파티션들을 어느 브로커로 분산시킬지 결졍
        - 분산대상 토픽, 파티션에 대한 JSON 파일 생성
        - [kafka-reassign-parition.sh](http://kafka-reassign-parition.sh) 명령어로 파티션을 분산시킬 브로커 리스트 지정
        - 실행한 출력 결과에서 제안한 파티션 배치를 복사하여 move.json 파일을 생성하여 붙여넣기
        - [kafka-reassign-parition.sh](http://kafka-reassign-parition.sh) 와 —reassignment-json-file 옵션으로 Move.json에 기반한 토픽의 파티션 배치 수행
- 분산 배치 작업시 주의사항
    - 버전 업그레이드 작업과 마찬가지로 사용량이 낮은 시간대에 진행하는 것을 권장
        - 단순 파티션 이동이 아니라 리플리케이션이 이루어지기 때문
    - 용량이 큰 토픽 파티션을 재배치할 때 필요한 일부 메시지만 재배치하여 리소스 소모를 줄이자
    - 여러개의 토픽을 동시에 재배치하지 않고, 한 번에 하나의 토픽만 진행한다.→ 카프카의 안정성 고려