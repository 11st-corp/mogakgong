# 10. 스키마 레지스트리

스키마는 정보를 구성하고 해석하는 것을 도와주는 프레임워크나 개념을 의미한다.

특히 DB의 구조를 정의하고 표현, 명세, 제약을 기술하는 표준 언어로 활용된다. 이를 통해 관리 효율성이 높아지며 데이터 충돌을 방지할 수 있다.

카프카는 스키마 레지스트리를 통해 스키마를 관리한다. 스키마 레지스트리는 스키마를 등록하고 관리하는 서버로, 카프카 클러스터와 분리되어 있다. 스키마 레지스트리는 REST API를 통해 스키마를 등록하고 조회할 수 있다.

<br>

## 10.1 스키마의 개념과 유용성

중앙 데이터 파이프라인 역할을 하는 카프카에서는 수많은 사용자가 수많은 토픽을 사용하고 이 때는 하나의 서비스가 아닌 각기 다른 서비스가 접근하게 될 것이다.

누군가의 실수로 사전에 정의되지 않은 형태의 데이터를 특정 토픽으로 보낸다면 그와 연결된 모든 시스템이 영향을 받게 될 수 있다.

카프카의 데이터 흐름은 브로드캐스팅 방식으로 데이터를 전송하는 프로듀서를 일방적으로 신뢰하고 있다. 이는 데이터의 유효성을 검증하지 않는다는 의미이다.

따라서, 프로듀서는 토픽의 데이터의 구조를 컨슈머에게 반드시 설명해야한다. 이를 위해 스키마를 사용한다.

또한, 스키마의 진화(새로운 데이터의 추가)를 지원하기 때문에 카프카를 사용하고 있는 수십, 수백의 애플리케이션의 영향없이 스키마의 변경이 가능하다.

DB 스키마와 같이 카프카 스키마에서도 주석을 통해 용도, 데이터 포켓 등을 자세하게 설명할 수 있다.

<br>

## 10.2 카프카와 스키마 레지스트리

### 10.2.1 스키마 레지스트리 개요

스키마 레지스트리라는 별도의 애플리케이션을 이용하여 스키마를 활용할 수 있다.


![04.png](resource%2F04.png)

스키마 레지스트리는 카프카 클러스터와 분리된 서버로, REST API를 통해 스키마를 등록하고 조회할 수 있다.

클라이언트들이 스키마 정보를 사용하기 위해서는 프로듀서와 컨슈머, 스키마 레지스트리 간에 직접 통신이 이뤄져야한다.

프로듀서는 스키마 레지스트리에 스키마를 등록하고, 스키마 레지스트리는 프로듀서에 의해 등록된 스키마 정보를 카프카의 내부 토픽에 저장한다.

이 때 저장된 스키마의 ID와 메시지를 함께 카프카로 전송하고, 컨슈머는 스키마 ID를 통해 스키마 레지스트리에 저장된 스키마 정보를 조회한다.

<br>

### 10.2.2 스키마 레지스트리의 에이브로 지원

에이브로는 시스템, 프로그래밍 언어, 프로세싱 프레임워크 사이에서 데이터 교환을 도와주는 오픈소스 직렬화 시스템이다.

빠른 바이너리 데이터 포맷을 지원하며 JSON 형태의 스키마를 정의할 수 있는 간결한 데이터 포맷이다.

컨플루언트는 에이브로 포맷을 권장하고 있다.

<br>

### 10.2.3 스키마 레지스트리 설치

스키마 레지스트리에서 제공하는 주요 API는 다음과 같다.

- `GET /schemas` : 등록된 전체 스키마 목록을 조회
- `GET /schemas/ids/{id}` : 특정 ID의 스키마 정보를 조회
- `GET /schemas/ids/{id}/versions` : 특정 ID의 스키마 버전 목록을 조회
- `GET /subjects` : 등록된 전체 서브젝트 목록을 조회
- `GET /subjects/{subject}/versions` : 특정 서브젝트의 버전 리스트 조회
- `GET /config` : 전역으로 설정된 호환성 레벨 조회
- `GET /config/{subject}` : 특정 서브젝트의 호환성 레벨 조회
- `DELETE /subjects/{subject}` : 특정 서브젝트의 모든 스키마 삭제
- `DELETE /subjects/{subject}/versions/{version}` : 특정 서브젝트의 특정 버전 스키마 삭제

<br>

## 10.3 스키마 레지스트리 실습

### 10.3.1 스키마 레지스트리와 클라이언트 동작

1. 프로듀서는 스키마 레지스트리의 스키마가 유효한지 확인한다, 확인되지 않으면 스키마를 등록하고 캐싱
2. 스키마 레지스트리는 현 스키마가 저장소에 저장된 스키마와 동일한지, 진화한 스키마인지를 확인한다.
3. 프로듀서는 레지스트리로부터 받은 스키마 ID를 사용해 ID와 메시지를 카프카로 전송한다.
4. 컨슈머는 메시지를 받으면 스키마 ID를 통해 스키마 레지스트리에 저장된 스키마 정보를 조회한다.

<br>

## 10.4 스키마 레지스트리 호환성

스키마 레지스트리에서는 하나의 서브젝트에 대한 버전 정보별로 진화하는 각 스키마를 관리해준다.

### 10.4.1 BACKWARD 호환성

스키마의 데이터 포맷의 변경이 필요한 경우, 데이터 포맷을 변경하면 스키마는 버전이 증가하게된다.

이렇게되면 스키마 레지스트리 내에는 버전별 스키마가 존재하게 된다.

BACKWARD 호환성은 이전 버전의 스키마로 생성된 프로듀서의 데이터를 컨슈머의 새로운 스키마로 읽을 수 있는 것을 의미한다.

이 레벨을 사용하게되면 자신과 동일한 버전, 하나 아래의 하위 버전까지의 호환성을 허용한다.

만약 모든 하위 버전에 대한 호환성을 허용하고 싶다면 BACKWARD_TRANSITIVE를 사용한다.

<br>

### 10.4.2 FORWARD 호환성

FORWARD 호환성은 새로운 스키마로 생성된 프로듀서의 데이터를 이전 버전의 컨슈머가 읽을 수 있는 것을 의미한다.

마찬가지로 모든 버전에 대한 호환성을 허용하고 싶다면 FORWARD_TRANSITIVE를 사용한다.

<br>

### 10.4.3 FULL 호환성

FULL 호환성은 BACKWARD와 FORWARD 호환성을 모두 만족하는 것을 의미한다.

