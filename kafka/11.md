# 11. 카프카 커넥트

카프카 커넥트는 아파치 카프카의 오픈소스 프로젝트 중 하나로써, DB 같은 외부 시스템과 카프카를 쉽게 연결하기 위한 프레임워크이다.

이를 사용해 대량의 데이터를 카프카 외부로 손쉽게 이동시킬 수 있다.

### 주요 장점

- 데이터 중심 파이프 라인: 다른 카프카로 데이터를 보내거나 가져옴
- 유연성과 확장성: 테스트 및 일회성 작업을 위한 단독 모드와, 대규모 운영 환경을 위한 분산모드로 실행 가능
- 재사용성과 기능 확장: 이미 만들어진 기존 커넥터를 활용할 수도 요구사항에 맞게 빠르게 확장이 가능, 운영 리소스 감소
- 장애 및 복구: 분산 모드로 실행하면 워커 노드의 장애 상황에도 유연하게 대응 가능

<br>

## 11.1 카프카 커넥트의 핵심 개념

카프카 클러스터를 먼저 구성한 후 클러스터의 양옆에 배치할 수 있다.

카프카를 기준으로 들어오고 나가는 양뱡향에 커넥트가 존재하는데, 구분을 위해 들어오는 소스 방향의 커넥트를 소스 커넥트, 나가는 싱크 방향의 커넥트를 싱크 커넥트라고 한다.

커넥터는 직접 데이터를 복사하지 않고 데이터를 어디에서 어디로 복사해야하는지에 대한 작업을 정의하고 관리한다.

태스크는 커넥터가 정의한 작업을 직접 수행한다.

<br>

## 11.2 카프카 커넥트의 내부 동작

분산 배치된 각 태스크들은 메시지들을 소스에서 카프카로 혹은 카프카에서 싱크로 이동시킨다.

커넥트 또한 파티셔닝 개념을 적용해 데이터들을 하위 집합으로 나눈다. 병렬 처리를 위해 토픽을 파티션으로 나누는 것과 동일하다.

커넥터에서 복사되어야하는 데이터들은 레코드들의 순서에 맞춰 파티셔닝되어야한다.

스트림에서 나뉜 각 파티션들은 각각의 태스크로 할당되고 태스크들은 데이터를 이동시키게된다.

각 파티션에는 오프셋이 함께 포함되어 있어서 장애나 실패 발생시 지정된 위치부터 다시 데이터를 이동시킬 수 있다.

<br>

## 11.4 분산 모드 카프카 커넥트

분산 모드에서의 카프카 커넥트는 메타 정보 저장소로 자신의 로컬 디스크가 아닌 카프카의 내부 토픽을 사용한다.

이를 통해 하나의 워커에 장애가 발생하더라도 다른 워커가 카프카로부터 쟁애가 발생한 워커에 대한 메타정보를 얻어갈 수 있다.

해당 토픽에는 커넥트에 대한 중요한 정보가 저장되어 있으므로 리플리케이션 팩터 수를 반드시 3으로 설정해야한다.

### 자동 리밸런싱

커넥트에 부하가 높아져 새로운 워커를 추가하면 커넥트는 즉시 확장된다.

리밸런싱을 통해 워커들 안에서 태스크와 커넥터가 균등하게 배치될 수 있도록 한다.

### 장애 허용

특정 워커에 장애가 발생한다면 해당 워커에 남아있던 태스크는 정상 동작중인 워커로 이동하여 본래의 작업을 처리한다.

<br>

## 11.5 커넥터 기반의 미러 메이커 2.0

다중 데이터 센터를 운영하고 각 데이터 센터에 존재하는 카프카 클러스터들의 리플리케이션을 장애 복구 차원에서 운용하거나, 온프레미스에서 클라우드로 데이터를 마이그레이션하는 경우에서도 리플리케이션이 필요하다.

이를 위한 도구로 아파치 카프카에서는 미러 메이커를 기본 도구로 제공한다. 이를 통해 카프카 간의 미러링이 가능하다.

### 원격 토픽과 에일리어스 기능

소스 클러스터에서 타깃 클러스터로 타깃 토픽들을 리플리케이션하는 기능이다. 이는 양방향 리플리케이션이 가능하다.

양방향 미러링의 경우에는 동일한 토픽명으로 인한 무한 루프 및 순서가 뒤섞이는 경우가 발생하기 때문에 토픽에 alias를 추가하여 서로의 토픽명을 구분할 수 있다.

### 카프카 클러스터 통합

미러링된 여러 토픽을 다운스트림의 컨슈머가 통합하여 컨슘할 수 있다.

### 무한 루프 방지

동시에 2개의 클러스터를 서로 리플리케이션할 때 발생할 수 있는 무한 루프 상황을 토픽의 이름 앞에 alias를 추가하므로 무한 루프를 방지한다.

### 토픽 설정 동기화

소스 토픽을 모니터링하고 토픽의 설정 변경사항을 원격의 대상 토픽으로 전파한다.

### 안정한 저장소로 내부 토픽 활용

미러 메이커는 내부적으로 미러 메이커가 잘 동작하고 있는지 health check를 하며, 주기적으로 미러링 관련 토픽, 파티션, 오프셋 정보 저장을 위해 카프카의 내부 토픽을 사용한다.

### 카프카 커넥트 지원

카프카 커넥트를 통해 동작 가능한 소스 커넥터와 싱크 커넥터를 지원함으로써 카프카 커넥트 기반으로 미러 메이커를 동작할 수 있다.

