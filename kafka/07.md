# 7. 카프카 배치

매우 안정적인 카프카 애플리케이션이지만 그래도 혹시 모를 상황을 대비하여 예방조치를 알아두는 것이 좋다.

다룰 내용

- 카프 클러스터 구축시 고려사항
- 안정적인 운영을 위한 모니터링 방법 (카프카 + 카프가가 실행되는 하드웨어 리소스)

# 안정적인 운영을 위한 주키퍼와 카프카 구성

## 주키퍼 구성

주키퍼 : 파티션과 브로커의 메타데이터를 저장하고 컨트롤러 서버를 선출

→ 최근 주키퍼의 의존성을 제거하려는 움직임이 있지만, 효율적인 방식으로 더 많은 파티션을 처리할 수 있기에 일단은 알아두면 좋을듯 (v4.0 에서 제거될 것이라고 함)

https://junuuu.tistory.com/812

- 주키퍼 서버 수량
    - 과반수(쿼럼-quorum) 구성을 기반으로 동작하기 때문에 홀수 개수로 구성
        - 카프카 사용량이 높지 않으면 - 주키퍼 3대로 구성
        - 핵심 파이프라인으로 카프카 이용 / 사용량은 낮지만 중요한 용도로 이용  - 주키퍼 5대구성
- 주키퍼 하드웨어
    - 메모리 4~8GB, 디스크 240G / 480G SSD 추천
    - 이유 : 주키퍼가 필요로 하는 heap 메모리 주로 1~2GB
        - 주키퍼는 트랜잭션이나 스냅샷 로그를 로컬 디스크에 저장
    - 네트워크 카드 1G 이더넷 카드 추천
        - 주키퍼와 카프카 간에 메타 데이터 정도만 주고 받기 때문에 주키퍼의 네트워크 사용량이 높지 않음
- 주키퍼 배치
    - 하나의 데이터 센터 랙에 모든 주키퍼 서버를 마운트하는 것은 위험
    - 주키퍼를 다른 랙에 분산 배치 권장 + 이중화, 스위치 이중화 장치 권장
    - AWS에서 구성시 멀티 가용 영역 권장

## 카프카 구성

- 카프카 서버 수량
    - 주키버와 다르게 과반수 방식의 구성 필요X - 짝수 개수 가능
    - 그러나 안정적인 리플리케이션 팩터 수(=3개)로 토픽을 구성하려면 최소 3대의 브로커가 필요함
    → 최소 서버 구성은 3대 추천
- 카프카 하드웨어
    - 주키퍼와 다르게 CPU사용률이 높다.
        - ex. 배치, 압축, 해제에 리소스 소모가 크다.
    - 메모리
        - JVM 힙 메모리 6GB 이상 - 최소 요구치가 6GB
        - 최소 32GB이상, 128/256GB 추천 - 그외 모든 물리 메모리를 페이지 캐시로 사용하기 때문
    - 디스크
        - SSD, SAS, SATA, NAS 다 괜찮다.
        - NAS도 사용가능하나, 장애시 큰 문제가 발생할 수 있으므로 권장X
        - 단, 토픽 보관 주기를 충분하게 설정하기 위해서는 4TB용량 이상의 디스크 권장
        - AWS EC2에서 사용OK
            - EBS 와 궁합이 좋음
    - 네트워크 카드 10G 이더넷 카드 추천
        - 일정 네트워크 사용률을 유지하기 위한 토픽 분산 운영&장애시 발생하는 대규모 데이터 이동을 지원하기 위해 대역폭 충분히 확보
- 카프카 배치
    - 주키퍼와 동일하게 분산하여 배치

# 모니터링 시스템 구성

카프카를 모니터링 하는 대표적인 방법 

- 애플리케이션 로그 분석 ✅
- JMX를 이용한 브로커들의 메트릭 정보 확인
    - cf - 브로커 로그 수집/분석은 NiFi, Elasticsearch

## 애플리케이션으로서 카프카의 로그 관리와 분석

카프카는 카프카 애플리케이션에서 발생하는 **모든 로그를 브로커의 로컬 디스크에 기록**

카프카의 로깅

- 아파치 log4j 사용
    - 로그 레벨별로 상황의 심각성 유추 - ex. TRACE, DEBUG, INFO, WARN, ERROR, FATAL
    - 로그 레벨 기본값 - INFO
- 로그 설정 파일
    - 로그 레벨 조정시 브로커 서버에서 [log4j.properties](http://log4j.properties) 파일 열어서 아래 프로퍼티 수정
        - log4j.logger.kafka
        - log4j.logger.org.apache.kafka
    - [log4j.properties](http://log4j.properties) 파일에서 설정한 로그 레벨의 범위까지 기록하기 때문에 DEBUG/TRACE 레벨까지 낮추면 디스크 용량이 많이 찰 수 있음
- 로그 파일
    - 정보 종류, 소스에 맞게 분류하여 로그파일을 기록
        - sever.log, state-change.log, kafka-request.log, log-cleaner.log, controller.log, kafka-authorizer.log

## JMX를 이용한 카프카 메트릭 정보 확인

JMX - 자바로 만든 애플리케이션의 모니터링을 위한 도구를 제공하는 API

JMX를 이용한 카프카 주요 매트릭 확인

- 카프카 JMX 설정
    - 브로커에 JMX 포트 오픈
- 매트릭 정보 GUI 형태로 보기
    - 프로메테우스(오픈소스 메트릭 기반 모니터링 시스템) 설치
    - 그라파나(대시보드 오픈소스 도구)도 같이 통합 설치
    - 익스포터 설치
        - 익스포터 란? 다양한 애플리케이션에서 수집되는 메트릭들을 프로메테우스가 인식할 수 있는 형태로 나타내는 에이전트
        - 프로메테우스의 모니터링 방식이 push가 아닌 pull이기 때문에 모니터링 대상 서버에 자신의 메트릭 정보를 보여줄 수 있는 익스포터를 설치해야한다.
        - 클러스터 내 모든 브로커에 설치할 것.
    - 순서
        - 익스포터 다운로드 → 익스포터 실행 → 프로메테우스 환경 설정 파일(prometheus.yml)에서 카프카 익스포터 추가 → 그라파나 대시보드 추가

## 카프카 익스포터

카프카 익스포터를 사용한, 컨슈머 LAG 모니터링

- 오픈소스 - https://github.com/danielqsj/kafka_exporter
- 카프카 익스포터 설치 순서
    - 앞서 본 익스포터 설치~대시보드 추가 순서와 동일

# 정리

- 오픈소스인 프로메테우스, 그라파나를 이용하여 카프카 모니터링 대시보드 구성 가능
- 그러나, 중요한 것은 관심을 가지고 주기적으로 모니터링할 것