# 컨슈머의 내주 동작 원리와 구현

---

## 6.1 컨슈머 오프셋 관리

컨슈머의 동작 중 가장 핵심은 오프셋 관리이다. 컨슈머는 카프카에 저장된 메시지를 꺼내오는 역할을 하기 때문에 컨슈머가 메시지를 어디까지 가져왔는지 표시하는 것은 매우 중요하다.

예를 들어 컨슈머가 일시적으로 동작을 멈추고 재시작 하는 경우나, 새로운 컨슈머가 기존 컨슈머의 역할을 대신하는 경우에 기존 컨슈머의 마지막 메시지 위치를 알고 가져와야지만 장애로부터 빠르게 복구할 수 있다.

카프카에서 메시지의 위치를 나타내는 위치를 오프셋<sup>offset</sup>이라고 부르는데 이 오프셋은 숫자 형태로 나타낸다.
컨슈머 그룹은 자신의 오프셋 정보를 카프카에서 가장 안전한 저장소인 **토픽**에 저장한다. 즉 **__consumer_offsets** 토픽에 각 컨슈머 그룹별로 오프셋 위치 정보가 기록된다.

컨슈머들은 지정된 토픽의 메시지를 읽은 뒤에 읽어온 위치의 오프셋 정보를 **__consumer_offsets**에 기록한다. 이 때 컨슈머 그룹은 컨슈머 그룹, 토픽, 파티션 등의 내용응 통합해 기록한다.
기록된 정보를 이용해 자신의 그룹이 속해 있는 컨슈머의 변경이 발생하는 경우 해당 컨슈머가 어느 위치까지 읽었는지를 추적할 수 있다.
여기서 저장되는 오프셋값은 컨슈머가 마지막까지 읽은 위치가 아니라 컨슈머가 다음으로 읽어야 할 위치이다.

## 6.2 그룹 코디네이터

컨슈머들은 하나의 컨슈머 그룹의 구성원으로 속하고 그룹 내 각 컨슈머들은 서로 자신의 정보를 공유하면서 하나의 공동체로 동작한다.

커슈머 그룹 내 컨슈머들은 언제든지 자신이 속한 컨슈머 그룹에서 떠날 수 있으며 새로운 컨슈머가 합류할 수도 있다. 따라서 컨슈머 그룹은 변화를 인지하고 각 컨슈머들에게 작업을 균등하게 분배해야 한다.

이렇게 작업을 균등하게 분배하는 동작을 컨슈머 리밸런싱<sup>consumer rebalancing</sup>이라고 부르거나 `'컨슈머 리밸런싱이 일어났다'` 라고 표현한다.

그룹 코디네이터는 각 컨슈머그룹 별로 존재하며, 카프카 클러스터 내의 브로커 중 하나에 위치하고 존재 목적은 컨슈머 그룹이 구독한 토픽의 파티션들과 그룹의 멤버들을 트래킹하는 것이다. 


컨슈머들의 변경을 감지하기 위해 그룹 코디네이터와 컨슈머들은 서로 주기적으로 하트비트<sup>heartbeat</sup>를 주고 받으면서 그룹 코디네이터는 컨슈머가 잘 살아 동작하는지 확인한다.
상태를 확인해 특정 컨슈머에 문제가 발생했다고 판단되면 **컨슈머 리밸런싱** 동작을 통해 컨슈머 그룹의 전체 균형을 다시 맞춘다.

이러한 컨슈머 리밸런싱 동작은 경우에 따라 높은 비용이 지출되므로 자주 발생되지 않도록 주의해야 한다.

## 6.3 스태틱 멤버십

점검, 업데이트 등의 이유로 컨슈머 그룹 내 컨슈머들을 하나씩 재시작하는 경우 하트비트 주기, 세션 타임아웃 등의 설정으로 하나의 컨슈머가 재시작될 때 마다 전체 리밸런싱이 일어나게 되면
작업하는동안 컨슈머들이 일시 중지되기 때문에 번거로워진다.

대용량 메시지들을 처리하는 컨슈머 그룹이라면 리밸런싱 동작으로 인해 원래 상태를 복구하는 데 상당한 시간이 소요될 수 있다.

카프카에서는 이러한 불필요 리밸런싱을 방어하기 위해 카프카 2.3버전 부터는 스태틱 멤버십<sup>static membership</sup>이라는 개념을 도입했다.

**스티택 멤버십**이란 컨슈머 그룹 내에서 재시작 등으로 그룹에서 나갔다가 다시 합류하더라도 리밸런싱이 일어나지 않게 되는데 컨슈머마다 인식할 수 있는 ID를 적용함으로써 다시 합류하더라도
그룹 코디네이터가 기존 구성원임을 인식할 수 있게 하는 것이다.

스태틱 멤버십 기능이 적용된 컨슈머는 그룹에서 떠날 때에도 이를 알리지 않으므로 불필요한 리밸런싱도 방지할 수 있다.

## 6.4 컨슈머 파티션 할당 전략

프로듀서의 파티셔너는 레코드를 토픽의 어느 파티션으로 전송할지 결정하는 역할을 했는데 컨슈머에서도 이와 유사하게 대상 토픽의 어느 파티션으로부터 레코드를 읽어 올지 결정을 한다.

컨슈머 그룹의 리더 컨슈머가 정해진 파티션 할당 전략에 따라 각 컨슈머와 대상 토픽의 파티션을 매칭시킨다.

파티션 할당 전략은 컨슈머 옵션에서 `partition.assignment.strategy`로 표시하며
- RangeAssignor(레인지 전략)
- RoundRobinAssignor(라운드로빈 전략)
- StickyAssignor(스티키 전략)
- CooperativeStickyAssignor(협력적 스티키 전략)
네 가지 전략이 제공되고 있다.

### 6.4.1 레인지 파티션 할당 전략

- 할당 전략 중 기본값
- 각 토픽 별로 할당 전략을 사용
- 먼저 구독하는 토픽에 대한 파티션을 순서대로 나열한 후에 컨슈머를 순서대로 정렬함
  - 그 다음 각 컨슈머가 몇개의 파티션을 할당행햐 하는지 전체 파티션 수를 컨슈머 수로 나눈다
- 컨슈머 수와 파티션 수가 일치하면 균등하게 할당될 수 있지만, 균등하게 나눠지지 않으면 앞쪽 컨슈머들이 추가 파티션을 할당받는다
- 이 전략은 동일한 레코드 키를 사용하고 하나의 컨슈머 그룹이 동일한 파티션 수를 가진 2개 이상의 토픽을 컨슘할 때 유용하다
- 컨슈머 그룹이 불균형한 상태로 운영될 수 있다는 점에 유의

### 6.4.2 라운드 로빈 할당 전략

- 컨슘해야 하는 모든 파티션과 컨슈머 그룹 내 모든 컨슈머를 나열한 후에 라운드 로빈으로 하나씩 파티션과 컨슈머를 할당하는 전략

### 6.4.3 스티키 파티션 할당 전략

- 레인지 파티션 할당 전략, 라운드 로빈 할당 전략 모두 컨슈머 그룹의 리밸런싱 동작으로 재할당 작업이 발생했을 때 기존에 매핑됐던 파티션과 동일한 컨슈머의 매핑을 보장할 수 없다.
- 재할당 작업이 발생하더라도 기존에 매핑됐던 파티션과 컨슈머를 최대한 유지하려고 하는 전략이다.
- 두 가지 목적으로 컨슈머에 파티션을 할당하는데
  - 가능한 균형 잡힌 파티션 할당
  - 재할당이 발생할 때 되도록 기존에 할당된 파티션 정보를 보장하는 것이다.

### 6.4.4 협력적 스티키 파티션 할당 전략
- 스티키 파티션 할당 전략에서 한층 더 고도화 된 리밸런싱 동작을 수행한다.